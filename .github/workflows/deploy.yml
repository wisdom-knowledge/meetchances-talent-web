name: æ„å»ºå¹¶éƒ¨ç½²åˆ°é˜¿é‡Œäº‘OSS

on:
  push:
    branches:
      - main
      - test
  pull_request:
    branches:
      - main
      - test

# è®¾ç½®GitHub Actionsæƒé™
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä»»åŠ¡ï¼ˆåœ¨mainæˆ–teståˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œï¼‰
  build-and-deploy:
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/test') && github.event_name == 'push'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'test' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        env:
          CI: false
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_AUTH_LOGIN_URL: ${{ secrets.VITE_AUTH_LOGIN_URL }}
          VITE_AUTH_LOGOUT_URL: ${{ secrets.VITE_AUTH_LOGOUT_URL }}
          VITE_INVITE_REDIRECT_URL: ${{ secrets.VITE_INVITE_REDIRECT_URL }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          VITE_APM_APP_ID: ${{ secrets.VITE_APM_APP_ID }}
          VITE_APM_APP_TOKEN: ${{ secrets.VITE_APM_APP_TOKEN }}
          VITE_APP_ENV: ${{ vars.VITE_APP_ENV }}
          VITE_RTC_APP_ID: ${{ vars.VITE_RTC_APP_ID }}
        run: pnpm run build

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "dist" ]; then
            echo "::error::æ„å»ºç›®å½• dist ä¸å­˜åœ¨!"
            exit 1
          fi
          echo "æ„å»ºæˆåŠŸï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: å®‰è£…é˜¿é‡Œäº‘OSSå·¥å…·
        run: |
          wget https://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64 -O ossutil
          chmod +x ossutil
          sudo mv ossutil /usr/local/bin/

      - name: é…ç½®OSSè®¿é—®
        env:
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT || 'oss-cn-beijing.aliyuncs.com' }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |
          if [ -z "$OSS_ACCESS_KEY_ID" ]; then
            echo "::error::OSS_ACCESS_KEY_ID secret æœªè®¾ç½®æˆ–ä¸ºç©º!"
            exit 1
          fi
          if [ -z "$OSS_ACCESS_KEY_SECRET" ]; then
            echo "::error::OSS_ACCESS_KEY_SECRET secret æœªè®¾ç½®æˆ–ä¸ºç©º!"
            exit 1
          fi
          echo "é…ç½®OSSè®¿é—®å‡­è¯..."
          ossutil config -i $OSS_ACCESS_KEY_ID -k $OSS_ACCESS_KEY_SECRET -e $OSS_ENDPOINT

      - name: ä¸Šä¼ æ–‡ä»¶åˆ°OSS
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
          OSS_PATH_PREFIX: ${{ secrets.OSS_PATH_PREFIX || '' }}
        run: |
          echo "ğŸ” å½“å‰åˆ†æ”¯: ${{ github.ref }}"
          echo "ğŸ“¦ ç›®æ ‡OSS Bucket: $OSS_BUCKET"
          TARGET_PATH="oss://$OSS_BUCKET/"
          if [ -n "$OSS_PATH_PREFIX" ]; then
            TARGET_PATH="oss://$OSS_BUCKET/$OSS_PATH_PREFIX/"
          fi
          echo "ğŸ“ ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          echo "ğŸš€ å¼€å§‹ä¸Šä¼ æ–‡ä»¶..."
          ossutil cp -r ./dist/ $TARGET_PATH --update --exclude ".*"
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼ŒéªŒè¯ä¸Šä¼ ç»“æœ:"
          ossutil ls $TARGET_PATH

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
          echo "âœ… æ–‡ä»¶ä¸Šä¼ åˆ°OSSå®Œæˆ"
          echo "ğŸ“¦ éƒ¨ç½²ç¯å¢ƒ: ${{ github.ref == 'refs/heads/main' && 'production' || 'testing' }}"
          echo "ğŸª£ ç›®æ ‡å­˜å‚¨æ¡¶: $OSS_BUCKET"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥!"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å’Œé…ç½®"

  # è‡ªåŠ¨æ‰“Tagä»»åŠ¡ï¼ˆä»…åœ¨mainåˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œï¼‰
  auto-tag:
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: è·å–å½“å‰ç‰ˆæœ¬å·å¹¶ç”Ÿæˆæ–°Tag
        id: generate-tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "æœ€æ–°Tag: $LATEST_TAG"
          VERSION=${LATEST_TAG#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "æ–°Tag: $NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT

          RELEASE_NOTES="## ğŸš€ è‡ªåŠ¨å‘å¸ƒ $NEW_TAG

          ### ğŸ“ å˜æ›´å†…å®¹
          - åŸºäºmainåˆ†æ”¯æœ€æ–°ä»£ç è‡ªåŠ¨æ„å»ºå‘å¸ƒ

          ### ğŸ”— ç›¸å…³é“¾æ¥
          - æäº¤è®°å½•: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          - æ„å»ºæ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### â° å‘å¸ƒæ—¶é—´
          $(date '+%Y-%m-%d %H:%M:%S UTC')"

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå¹¶æ¨é€Tag
        env:
          NEW_TAG: ${{ steps.generate-tag.outputs.NEW_TAG }}
        run: |
          git tag -a "$NEW_TAG" -m "ğŸš€ è‡ªåŠ¨å‘å¸ƒ $NEW_TAG

          ğŸ”„ åŸºäºmainåˆ†æ”¯æäº¤ ${{ github.sha }} è‡ªåŠ¨åˆ›å»º
          ğŸ—ï¸ æ„å»ºID: ${{ github.run_id }}
          ğŸ“… åˆ›å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git push origin "$NEW_TAG"
          echo "âœ… Tag $NEW_TAG åˆ›å»ºå¹¶æ¨é€æˆåŠŸ!"

      - name: åˆ›å»ºGitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.generate-tag.outputs.NEW_TAG }}
          release_name: ğŸš€ Release ${{ steps.generate-tag.outputs.NEW_TAG }}
          body: ${{ steps.generate-tag.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false

      - name: Tagåˆ›å»ºæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ è‡ªåŠ¨Tagåˆ›å»ºæˆåŠŸ!"
          echo "ğŸ·ï¸ æ–°Tag: ${{ steps.generate-tag.outputs.NEW_TAG }}"
          echo "ğŸ“¦ GitHub Releaseå·²åˆ›å»º"
          echo "ğŸ”— æŸ¥çœ‹Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.generate-tag.outputs.NEW_TAG }}"

      - name: Tagåˆ›å»ºå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ è‡ªåŠ¨Tagåˆ›å»ºå¤±è´¥!"
          echo "è¯·æ£€æŸ¥æƒé™è®¾ç½®å’ŒGité…ç½®"


